---
import { type CollectionEntry, getCollection } from "astro:content";
import { Image } from "astro:assets";
import Default from "@layouts/Default.astro";
import { Icon } from "astro-icon/components";
import { SEO } from "astro-seo";
import { getCdnUrl } from "@lib/cdn-utils";

export const prerender = true;

interface Props {
  entry: CollectionEntry<"projects">;
}

function linkInstagramUsernames(text: string) {
  if (!text) return "";
  return text.replace(/@([a-zA-Z0-9_.]+)/g, (_, username) => {
    return `<a class="link" href="https://www.instagram.com/${username}" target="_blank">@${username}</a>`;
  });
}

export async function getStaticPaths() {
  const projects = await getCollection("projects");
  return projects.map((entry: { id: any }) => ({
    params: { id: entry.id },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { data } = entry;
const photos = data.images;

function formatDate(date: number | Date) {
  const options = {
    weekday: "long",
    year: "numeric",
    month: "long",
    day: "numeric",
  } as const;
  return new Intl.DateTimeFormat("it-IT", options).format(date);
}

const absoluteImageUrl = getCdnUrl(data.heroImage);

// Pre-calculate image data for the gallery
import { getImage } from "astro:assets";

const galleryImages = await Promise.all(
  photos.map(async (photo) => {
    const url = getCdnUrl(photo);
    // Infer dimensions for PhotoSwipe (full resolution)
    const fullImageInfo = await getImage({
      src: url,
      inferSize: true,
    });

    return {
      src: url,
      width: fullImageInfo.attributes.width,
      height: fullImageInfo.attributes.height,
      aspectRatio: fullImageInfo.attributes.width / fullImageInfo.attributes.height,
    };
  }),
);

function isVertical(width: number, height: number) {
  return height > width;
}
---

<Default>
  <SEO
    slot="head"
    openGraph={{
      basic: {
        title: data.title,
        type: "website",
        image: absoluteImageUrl,
      },
      optional: {
        description: data.credit,
      },
      image: {
        alt: data.title,
      },
    }}
  />

  <a href="/projects" class="btn btn-neutral text-xl"><Icon name="material-symbols:arrow-back" /> Altri Progetti</a>
  <div class="flex flex-col items-center justify-center m-4">
    <div class="card card-border border-base-300 m-6 bg-base-100">
      <figure>
        <div class="aspect-video">
          <Image src={absoluteImageUrl} alt={data.title} width={1280} height={720} class="w-full h-full object-cover" />
        </div>
      </figure>
      <div class="card-body">
        <h2 class="card-title">
          {data.title}
        </h2>
        <div class="badge badge-secondary">{formatDate(data.pubDate)}</div>
        <p set:html={linkInstagramUsernames(data.credit)} />
        <p set:html={linkInstagramUsernames(data.colorCorrection ?? "")} />
        <p set:html={linkInstagramUsernames(data.editing ?? "")} />
      </div>
    </div>
  </div>

  <div class="flex flex-col items-center justify-center mt-4">
    <div class="pswp-gallery grid grid-cols-1 min-[355px]:grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 auto-rows-[120px]" id="gallery">
      {
        galleryImages.map((image) => (
          <a href={image.src} data-pswp-width={image.width} data-pswp-height={image.height} class={`${isVertical(image.width, image.height) ? "row-span-2" : ""}`} target="_blank">
            <div class={`block w-44 h-full ${isVertical(image.width, image.height) ? "h-full" : "aspect-video"}`}>
              <Image src={image.src} alt={data.title} width={400} height={Math.round(400 * (image.height / image.width))} class="rounded-btn object-cover h-full w-full" />
            </div>
          </a>
        ))
      }
    </div>
  </div>
</Default>

<script>
  import PhotoSwipeLightbox from "photoswipe/lightbox";
  import "photoswipe/style.css";

  const lightbox = new PhotoSwipeLightbox({
    gallery: "#gallery",
    children: "a",
    pswpModule: () => import("photoswipe"),
    wheelToZoom: true,
    pinchToClose: false,
  });

  lightbox.init();
</script>
